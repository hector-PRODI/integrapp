{% extends "base.html" %}
{% block title %}Gestión de Usuarios{% endblock %}
{% block content %}
    <h2 class="mb-4">Gestión de Usuarios</h2>
    
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="bi bi-plus-circle"></i> Nuevo Usuario
    </button>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="userTable">
            <thead class="table-dark">
                <tr>
                    <th>Nº</th>
                    <th>DNI/NIE</th>
                    <th>GESPRODI</th>
                    <th>Nombre</th>
                    <th>Apellido 1</th>
                    <th>Apellido 2</th>
                    <th>Teléfono</th>
                    <th>Colectivo</th>
                    <th>Acciones</th>
                    <th>Incidencia</th>
                    <th>Entidad</th>
                    <th>Acceso</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm" class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" name="dni_nie" 
                                   placeholder="DNI/NIE" 
                                   pattern="\d{8}[A-Za-z]" 
                                   title="8 dígitos seguidos de una letra (ej: 12345678X)"
                                   required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" name="gesprodi" placeholder="GESPRODI">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" name="nombre" placeholder="Nombre" required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" name="apellido1" placeholder="Apellido 1" required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" name="apellido2" placeholder="Apellido 2">
                        </div>
                        <div class="col-md-6">
                            <input type="tel" class="form-control" name="telefono" placeholder="Teléfono" required>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" name="colectivo" required>
                                <option value="">Seleccione Colectivo</option>
                                <option>Desemplead@</option>
                                <option>Discapacidad</option>
                                <option>Mayores</option>
                                <option>Exclusión</option>
                                <option>Inmigrantes</option>
                                <option>Jóvenes sin experiencia laboral</option>
                                <option>Mayores de 45</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" name="acciones" required>
                                <option value="">Seleccione Acción</option>
                                <option>Espera</option>
                                <option>Citada</option>
                                <option>Atendida</option>
                                <option>No interesa</option>
                                <option>Ocupada</option>
                                <option>No acude</option>
                                <option>Derivada</option>
                                <option>No contesta</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" name="incidencia">
                                <option value="">Seleccione Incidencia</option>
                                <option>Error de conexión</option>
                                <option>No hay información</option>
                                <option>Baja administrativa</option>
                                <option>Participante con otra entidad</option>
                                <option>Error NIE</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" name="entidad_asignada" required>
                                <option value="">Entidad Asignada</option>
                                <option>Prodiversa</option>
                                <option>Mitad del cielo</option>
                                <option>Acompanya</option>
                                <option>Forprocer</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" name="acceso_programa" required>
                                <option value="">Acceso al Programa</option>
                                <option>Sí</option>
                                <option>No</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <textarea class="form-control" name="observaciones" 
                                      placeholder="Observaciones" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">Guardar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        
        function loadTableData(users) {
            const tbody = $('#userTable tbody');
            tbody.empty();
            users.forEach(user => {
                tbody.append(`
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.dni_nie}</td>
                        <td>${user.gesprodi || ''}</td>
                        <td>${user.nombre}</td>
                        <td>${user.apellido1}</td>
                        <td>${user.apellido2 || ''}</td>
                        <td>${user.telefono}</td>
                        <td>${user.colectivo}</td>
                        <td>${user.acciones}</td>
                        <td>${user.incidencia || ''}</td>
                        <td>${user.entidad_asignada}</td>
                        <td>${user.acceso_programa}</td>
                        <td>${user.observaciones || ''}</td>
                    </tr>
                `);
            });
        }

        function updateTable() {
            $.get('/get_users', function(users) {
                loadTableData(users);
            });
        }

        function addUser() {
            const formData = {
                dni_nie: $('input[name="dni_nie"]').val(),
                gesprodi: $('input[name="gesprodi"]').val(),
                nombre: $('input[name="nombre"]').val(),
                apellido1: $('input[name="apellido1"]').val(),
                apellido2: $('input[name="apellido2"]').val(),
                telefono: $('input[name="telefono"]').val(),
                colectivo: $('select[name="colectivo"]').val(),
                acciones: $('select[name="acciones"]').val(),
                incidencia: $('select[name="incidencia"]').val(),
                entidad_asignada: $('select[name="entidad_asignada"]').val(),
                acceso_programa: $('select[name="acceso_programa"]').val(),
                observaciones: $('textarea[name="observaciones"]').val()
            };

            $.ajax({
                url: '/add_user',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function() {
                    $('#addUserModal').modal('hide');
                    document.getElementById('userForm').reset();
                },
                error: function(xhr) {
                    const error = JSON.parse(xhr.responseText).error;
                    alert('Error: ' + error);
                }
            });
        }

        $(document).ready(function() {
            updateTable();
            socket.on('update', updateTable);
        });
    </script>
{% endblock %}