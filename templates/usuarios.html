{% extends "base.html" %}
{% block title %}Usuarios{% endblock %}
{% block content %}
    <h2>Usuarios</h2>
    
    <div class="row mb-3">
        <div class="col">
            <input type="text" class="form-control filter" data-column="0" placeholder="Filter DNI">
        </div>
        <div class="col">
            <input type="text" class="form-control filter" data-column="1" placeholder="Filter Nombre">
        </div>
        <div class="col">
            <input type="text" class="form-control filter" data-column="2" placeholder="Filter Apellidos">
        </div>
        <div class="col">
            <select class="form-select filter" data-column="3">
                <option value="">All Estados</option>
                <option>Desempleado</option>
                <option>Discapacitado</option>
                <option>Prestacion</option>
            </select>
        </div>
        <div class="col">
            <input type="text" class="form-control filter" data-column="4" placeholder="Filter Técnico">
        </div>
    </div>

    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addModal">
        Add New User
    </button>

    <table class="table table-striped mb-5" id="userTable">
        <thead>
            <tr>
                <th>DNI</th>
                <th>Nombre</th>
                <th>Apellidos</th>
                <th>Estado</th>
                <th>Técnico</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="mt-5">
        <h4>User Distribution by Estado</h4>
        <div style="max-width: 500px; margin: 0 auto">
            <canvas id="estadoChart"></canvas>
        </div>
    </div>

    <div class="modal fade" id="addModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="mb-3">
                            <input type="text" class="form-control" name="dni" placeholder="DNI" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" name="nombre" placeholder="Nombre" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" name="apellidos" placeholder="Apellidos" required>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" name="estado" required>
                                <option value="">Select Estado</option>
                                <option>Desempleado</option>
                                <option>Discapacitado</option>
                                <option>Prestacion</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" name="tecnico" required></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">Save</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const socket = io();
        let chartInstance = null;

        function loadTableData(users) {
            const tbody = $('#userTable tbody');
            tbody.empty();
            users.forEach(user => {
                tbody.append(`
                    <tr>
                        <td>${user.dni}</td>
                        <td>${user.nombre}</td>
                        <td>${user.apellidos}</td>
                        <td>${user.estado}</td>
                        <td>${user.tecnico}</td>
                    </tr>
                `);
            });
        }

        function updateTecnicoDropdown() {
            $.get('/get_tecnicos', function(tecnicos) {
                const select = $('select[name="tecnico"]');
                select.empty();
                tecnicos.forEach(tec => {
                    select.append(`<option>${tec.nombre}</option>`);
                });
            });
        }

        function updateChart() {
            $.get('/estado_stats', function(response) {
                const ctx = document.getElementById('estadoChart').getContext('2d');
                if(chartInstance) chartInstance.destroy();
                
                chartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: response.labels,
                        datasets: [{
                            data: response.data,
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            });
        }

        function updateTable() {
            $.get('/get_users', function(users) {
                loadTableData(users);
                updateChart();
            });
        }

        $('.filter').on('input', function() {
            const column = $(this).data('column');
            const value = $(this).val().toLowerCase();
            $('#userTable tbody tr').each(function() {
                const cell = $(this).find('td').eq(column).text().toLowerCase();
                $(this).toggle(cell.includes(value));
            });
        });

        function addUser() {
            const formData = {
                dni: $('input[name="dni"]').val(),
                nombre: $('input[name="nombre"]').val(),
                apellidos: $('input[name="apellidos"]').val(),
                estado: $('select[name="estado"]').val(),
                tecnico: $('select[name="tecnico"]').val()
            };

            $.ajax({
                url: '/add_user',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function() {
                    $('#addModal').modal('hide');
                    document.getElementById('userForm').reset();
                },
                error: function(xhr) {
                    alert('Error: ' + JSON.parse(xhr.responseText).error);
                }
            });
        }

        $(document).ready(function() {
            updateTable();
            updateTecnicoDropdown();
            socket.on('update', updateTable);
        });
    </script>
{% endblock %}